<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Chat room</title>
    <link rel="stylesheet" href="../css/room.css">
</head>

<body>
    <%
        // グループ化: reactedEmojis をメッセージ毎、かつ絵文字毎にまとめる
        let reactionsByMessage = {};

        reactedEmojis.forEach(function (reaction) {
            let msgId = reaction.message_id;
            if (!reactionsByMessage[msgId]) { reactionsByMessage[msgId] = {}; }
            let emojiId = reaction.emoji_id;
            if (!reactionsByMessage[msgId][emojiId]) {
                reactionsByMessage[msgId][emojiId] = {
                    count: 0,
                    reactedByUser: false,
                    emoji_name: reaction.emoji_name,
                    emoji_image: reaction.emoji_image
                };
            }

            reactionsByMessage[msgId][emojiId].count++;

            if (reaction.reacter_id === userId) {
                reactionsByMessage[msgId][emojiId].reactedByUser = true;
            }
        }); // unread marker flag

        let insertedUnreadMarker = false;    

    %>

    <h1>Room: <%= roomName[0].room_name %>
    </h1>
    <button onclick="location.href='/invite_people/<%= roomId %>'">Invite people</button>


        <div>
            <% if (messages && messages.length> 0) { %>
                <% messages.forEach(msg=> {
                    // check if the message is sent by the user
                    let isSelf = (msg.sender_id && msg.sender_id === userId) ||
                    (!msg.sender_id && msg.sender_name === username);
                    %>

                    <% if (!insertedUnreadMarker && msg.unread==1) { insertedUnreadMarker=true; %>
                        <div class="unread-marker">
                            <p>- - - - - - - unread messages- - - - - - -</p>
                        </div>
                        <% } %>

                            <div class="message-container <%= isSelf ? 'right' : 'left' %>">
                                <div class="message-wrapper">
                                    <div class="sender-name">
                                        <%= msg.sender_name %>
                                    </div>
                                    <div class="message-box <%= isSelf ? 'self' : '' %>">
                                        <%= msg.text %>
                                    </div>

                                    <% // msg.sent_datetime
                                    let d = new Date(msg.sent_datetime);
                                    let datePart=d.toLocaleDateString('en-US', { month: 'short' , day: 'numeric' , year: 'numeric' });
                                    let timePart=d.toLocaleTimeString('en-US', { hour: '2-digit' , minute: '2-digit' , hour12: false });
                                    %>

                                    <div class="sent-datetime">
                                        <%= datePart %> <%= timePart %>
                                    </div>

                                    <!-- emoji reactions -->
                                    <% if (reactionsByMessage[msg.message_id]) { %>
                                        <div class="reactions">
                                            <% Object.keys(reactionsByMessage[msg.message_id]).forEach(function(emojiId)
                                                { let reaction=reactionsByMessage[msg.message_id][emojiId]; %>
                                                <span class="reaction">
                                                    <img src="/<%= reaction.emoji_image %>"
                                                        alt="<%= reaction.emoji_name %>" class="emoji-icon">
                                                    <% if (reaction.count> 1) { %>
                                                        <span class="reaction-count">
                                                            <%= reaction.count %>
                                                        </span>
                                                        <% } %>
                                                            <!-- check reaction by the user -->
                                                            <% if (reaction.reactedByUser) { %>
                                                                <button class="reaction-btn remove-reaction"
                                                                    data-message-id="<%= msg.message_id %>"
                                                                    data-emoji-id="<%= emojiId %>">[-]</button>
                                                                <% } else { %>
                                                                    <button class="reaction-btn add-reaction"
                                                                        data-message-id="<%= msg.message_id %>"
                                                                        data-emoji-id="<%= emojiId %>">[+]</button>
                                                                    <% } %>
                                                </span>
                                                <% }); %>
                                        </div>
                                        <% } else { %>
                                            <!-- もしそのメッセージに一件も反応がなければ、[+]ボタンを表示 -->
                                            <div class="reactions">
                                                <button class="reaction-btn add-reaction"
                                                    data-message-id="<%= msg.message_id %>"
                                                    data-emoji-id="">[+]</button>
                                            </div>
                                            <% } %>

                                </div>
                            </div>
                            <% }); %>
                                <% } else { %>
                                    <p>No message in the room.</p>
                                    <% } %>
        </div>

        <!-- form for a new message -->
        <div class="new-message">
            <form action="/room/<%= roomId %>/send" method="POST">
                <textarea name="messageText" placeholder="Type your message here" required></textarea>
                <button type="submit">Send</button>
            </form>
        </div>

</body>

</html>